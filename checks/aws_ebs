#!/usr/bin/env python3
# Copyright (C) 2019 tribe29 GmbH - License: GNU General Public License v2
# This file is part of Checkmk (https://checkmk.com). It is subject to the terms and
# conditions defined in the file COPYING, which is part of this source code package.

# NOTE: Careful when replacing the *-import below with a more specific import. This can cause
# problems because it might remove variables needed for accessing discovery rulesets.
from collections.abc import Mapping
from typing import Any

from cmk.base.check_legacy_includes.aws import *  # pylint: disable=wildcard-import,unused-wildcard-import

# .
#   .--burst balance-------------------------------------------------------.
#   |    _                    _     _           _                          |
#   |   | |__  _   _ _ __ ___| |_  | |__   __ _| | __ _ _ __   ___ ___     |
#   |   | '_ \| | | | '__/ __| __| | '_ \ / _` | |/ _` | '_ \ / __/ _ \    |
#   |   | |_) | |_| | |  \__ \ |_  | |_) | (_| | | (_| | | | | (_|  __/    |
#   |   |_.__/ \__,_|_|  |___/\__| |_.__/ \__,_|_|\__,_|_| |_|\___\___|    |
#   |                                                                      |
#   '----------------------------------------------------------------------'
Section = Mapping[str, Mapping[str, float]]


def discover_aws_ebs_burst_balance(section: Section):
    yield from inventory_aws_generic(
        section,
        ["BurstBalance"],
    )


def check_aws_ebs_burst_balance(
    item: str,
    params: Mapping[str, Any],
    section: Section,
):
    if (disk_data := section.get(item)) is None:
        return

    warn, crit = params.get("burst_balance_levels_lower", (None, None))

    yield check_levels(
        disk_data["BurstBalance"],
        "aws_burst_balance",
        (None, None, warn, crit),
        human_readable_func=get_percent_human_readable,
        infoname="Balance",
    )


check_info["aws_ebs.burst_balance"] = {
    "inventory_function": discover_aws_ebs_burst_balance,
    "check_function": check_aws_ebs_burst_balance,
    "service_description": "AWS/EBS Burst Balance %s",
    "group": "aws_ebs_burst_balance",
    "has_perfdata": True,
}
