#!/usr/bin/env python3
# -*- coding: utf-8 -*-
# Copyright (C) 2019 tribe29 GmbH - License: GNU General Public License v2
# This file is part of Checkmk (https://checkmk.com). It is subject to the terms and
# conditions defined in the file COPYING, which is part of this source code package.

from typing import Any, Mapping

from cmk.base.check_legacy_includes.df import df_check_filesystem_list, filesystem_groups
from cmk.base.check_legacy_includes.hitachi_hnas import hitachin_hnas_scan_function
from cmk.base.plugins.agent_based.agent_based_api.v1.type_defs import StringTable
from cmk.base.plugins.agent_based.utils.df import df_discovery, FILESYSTEM_DEFAULT_PARAMS, FSBlock

Section = Mapping[str, FSBlock]


def parse_hitachi_hnas_span(string_table: StringTable) -> Section:
    section = {}
    for id_, label, total_upper, total_lower, used_upper, used_lower in string_table:
        item = f"{id_} {label}"
        size_mb = (int(total_upper) * 2**32 + int(total_lower)) / 1024.0**2
        avail_mb = size_mb - (int(used_upper) * 2**32 + int(used_lower)) / 1024.0**2
        section[item] = (item, size_mb, avail_mb, 0.0)

    return section


def discover_hitachi_hnas_span(section: Section):
    params = host_extra_conf(host_name(), filesystem_groups)
    return df_discovery(params, list(section.values()))


def check_hitachi_hnas_span(item: str, params: Mapping[str, Any], section: Section):
    if (fs := section.get(item)) is None:
        return None

    return df_check_filesystem_list(item, params, [fs])


check_info["hitachi_hnas_span"] = {
    "service_description": "Span %s",
    "parse_function": parse_hitachi_hnas_span,
    "inventory_function": discover_hitachi_hnas_span,
    "check_function": check_hitachi_hnas_span,
    "has_perfdata": True,
    "snmp_info": (
        ".1.3.6.1.4.1.11096.6.1.1.6.4.2.1",
        [
            1,  # spanStatsSpanId
            2,  # spanLabel
            3,  # spanCapacityTotalUpper
            4,  # spanCapacityTotalLower
            5,  # spanCapacityUsedUpper
            6,  # spanCapacityUsedLower
        ],
    ),
    "snmp_scan_function": hitachin_hnas_scan_function,
    "group": "filesystem",
    "default_levels_variable": "filesystem_default_levels",
}

factory_settings["filesystem_default_levels"] = FILESYSTEM_DEFAULT_PARAMS
