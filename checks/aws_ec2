#!/usr/bin/env python3
# Copyright (C) 2019 tribe29 GmbH - License: GNU General Public License v2
# This file is part of Checkmk (https://checkmk.com). It is subject to the terms and
# conditions defined in the file COPYING, which is part of this source code package.

# NOTE: Careful when replacing the *-import below with a more specific import. This can cause
# problems because it might remove variables needed for accessing discovery rulesets.
from cmk.base.check_legacy_includes.aws import *  # pylint: disable=wildcard-import,unused-wildcard-import

# .
#   .--CPU credits---------------------------------------------------------.
#   |           ____ ____  _   _                     _ _ _                 |
#   |          / ___|  _ \| | | |   ___ _ __ ___  __| (_) |_ ___           |
#   |         | |   | |_) | | | |  / __| '__/ _ \/ _` | | __/ __|          |
#   |         | |___|  __/| |_| | | (__| | |  __/ (_| | | |_\__ \          |
#   |          \____|_|    \___/   \___|_|  \___|\__,_|_|\__|___/          |
#   |                                                                      |
#   '----------------------------------------------------------------------'

factory_settings["aws_cpu_credits"] = {
    "balance_levels_lower": (10, 5),
}


def check_aws_ec2_cpu_credits(item, params, parsed):
    return check_aws_metrics(
        [
            {
                "metric_val": parsed.get(cw_metric_name),
                "metric_name": metric_name,
                "levels": levels,
                "human_readable_func": human_readable_func,
                "info_name": info_name,
            }
            for cw_metric_name, metric_name, levels, human_readable_func, info_name in zip(
                ["CPUCreditUsage", "CPUCreditBalance"],
                [None, "aws_cpu_credit_balance"],
                [None, (None, None) + params["balance_levels_lower"]],
                [lambda x: "%.2f" % x] * 2,
                ["Usage", "Balance"],
            )
        ]
    )


check_info["aws_ec2.cpu_credits"] = {
    # section is already migrated!
    "inventory_function": lambda p: inventory_aws_generic_single(
        p,
        ["CPUCreditUsage", "CPUCreditBalance"],
    ),
    "check_function": check_aws_ec2_cpu_credits,
    "service_description": "AWS/EC2 CPU Credits",
    "group": "aws_ec2_cpu_credits",
    "default_levels_variable": "aws_cpu_credits",
    "has_perfdata": True,
}
